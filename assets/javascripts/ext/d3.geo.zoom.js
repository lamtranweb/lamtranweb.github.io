// Copyright 2014, Jason Davies, http://www.jasondavies.com
// See LICENSE.txt for details.

(function(){function n(e,t,n){var r=e.translate(),i=Math.atan2(t[1]-r[1],t[0]-r[0])-Math.atan2(n[1]-r[1],n[0]-r[0]);return[Math.cos(i/2),0,0,Math.sin(i/2)]}function r(e,t){var n=e.invert(t);return n&&isFinite(n[0])&&isFinite(n[1])&&f(n)}function i(t){var n=.5*t[0]*e,r=.5*t[1]*e,i=.5*t[2]*e,s=Math.sin(n),o=Math.cos(n),u=Math.sin(r),a=Math.cos(r),f=Math.sin(i),l=Math.cos(i);return[o*a*l+s*u*f,s*a*l-o*u*f,o*u*l+s*a*f,o*a*f-s*u*l]}function s(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=t[0],u=t[1],a=t[2],f=t[3];return[n*o-r*u-i*a-s*f,n*u+r*o+i*f-s*a,n*a-r*f+i*o+s*u,n*f+r*a-i*u+s*o]}function o(e,t){if(!e||!t)return;var n=c(e,t),r=Math.sqrt(l(n,n)),i=.5*Math.acos(Math.max(-1,Math.min(1,l(e,t)))),s=Math.sin(i)/r;return r&&[Math.cos(i),n[2]*s,-n[1]*s,n[0]*s]}function u(e,t){var n=Math.max(-1,Math.min(1,l(e,t))),r=n<0?-1:1,i=Math.acos(r*n),s=Math.sin(i);return s?function(n){var o=r*Math.sin((1-n)*i)/s,u=Math.sin(n*i)/s;return[e[0]*o+t[0]*u,e[1]*o+t[1]*u,e[2]*o+t[2]*u,e[3]*o+t[3]*u]}:function(){return e}}function a(e){return[Math.atan2(2*(e[0]*e[1]+e[2]*e[3]),1-2*(e[1]*e[1]+e[2]*e[2]))*t,Math.asin(Math.max(-1,Math.min(1,2*(e[0]*e[2]-e[3]*e[1]))))*t,Math.atan2(2*(e[0]*e[3]+e[1]*e[2]),1-2*(e[2]*e[2]+e[3]*e[3]))*t]}function f(t){var n=t[0]*e,r=t[1]*e,i=Math.cos(r);return[i*Math.cos(n),i*Math.sin(n),Math.sin(r)]}function l(e,t){for(var n=0,r=e.length,i=0;n<r;++n)i+=e[n]*t[n];return i}function c(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]}function h(e){var t=0,n=arguments.length,r=[];while(++t<n)r.push(arguments[t]);var i=d3.dispatch.apply(null,r);return i.of=function(t,n){return function(r){try{var s=r.sourceEvent=d3.event;r.target=e,d3.event=r,i[r.type].apply(t,n)}finally{d3.event=s}}},i}var e=Math.PI/180,t=180/Math.PI;d3.geo.zoom=function(){function g(e){c++||e({type:"zoomstart"})}function y(e){e({type:"zoom"})}function b(e){--c||e({type:"zoomend"})}var e,t,l,c=0,p=h(d,"zoomstart","zoom","zoomend"),d=d3.behavior.zoom().on("zoomstart",function(){var t=d3.mouse(this),u=i(e.rotate()),f=r(e,t);f&&(l=f),v.call(d,"zoom",function(){e.scale(m.k=d3.event.scale);var i=d3.mouse(this),f=o(l,r(e,i));e.rotate(m.r=a(u=f?s(u,f):s(n(e,t,i),u))),t=i,y(p.of(this,arguments))}),g(p.of(this,arguments))}).on("zoomend",function(){v.call(d,"zoom",null),b(p.of(this,arguments))}),v=d.on,m={r:[0,0,0],k:1};return d.rotateTo=function(e){var t=o(f(e),f([-m.r[0],-m.r[1]]));return a(s(i(m.r),t))},d.projection=function(t){return arguments.length?(e=t,m={r:e.rotate(),k:e.scale()},d.scale(m.k)):e},d.duration=function(e){return arguments.length?(t=e,d):t},d.event=function(n){n.each(function(){var n=d3.select(this),r=p.of(this,arguments),s=m,o=d3.transition(n);if(o!==n){o.each("start.zoom",function(){this.__chart__&&(m=this.__chart__),e.rotate(m.r).scale(m.k),g(r)}).tween("zoom:zoom",function(){var n=d.size()[0],f=u(i(m.r),i(s.r)),l=d3.geo.distance(m.r,s.r),c=d3.interpolateZoom([0,0,n/m.k],[l,0,n/s.k]);return t&&o.duration(t(c.duration*.001)),function(t){var i=c(t);this.__chart__=m={r:a(f(i[0]/l)),k:n/i[2]},e.rotate(m.r).scale(m.k),d.scale(m.k),y(r)}}).each("end.zoom",function(){b(r)});try{o.each("interrupt.zoom",function(){b(r)})}catch(f){}}else this.__chart__=m,g(r),y(r),b(r)})},d3.rebind(d,p,"on")}})();